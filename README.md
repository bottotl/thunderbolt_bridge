# é›·é›³æ¡¥æ¥ç½‘ç»œé…ç½®å·¥å…·

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„é›·é›³æ¡¥æ¥ç½‘ç»œé…ç½®å·¥å…·åŒ…ï¼Œè§£å†³äº†macOSä¸Šé›·é›³æ¡¥æ¥ç½‘ç»œé…ç½®ä¸ç¨³å®šã€éœ€è¦é¢‘ç¹é‡æ–°æ‰§è¡Œè„šæœ¬çš„é—®é¢˜ã€‚

## æ ¸å¿ƒé—®é¢˜è§£å†³

### åŸé—®é¢˜
ä¸»æœºç«¯éœ€è¦é¢‘ç¹é‡æ–°æ‰§è¡Œé…ç½®è„šæœ¬çš„åŸå› ï¼š
- **é…ç½®ä¸æŒä¹…åŒ–**: ç³»ç»Ÿé‡å¯åç½‘ç»œé…ç½®ä¸¢å¤±
- **ç³»ç»Ÿå¹²æ‰°**: macOSè‡ªåŠ¨é‡ç½®ç½‘ç»œé…ç½®
- **æ¥å£çŠ¶æ€é—®é¢˜**: é›·é›³çº¿ç¼†æ–­å¼€é‡è¿å¯¼è‡´é…ç½®å¤±æ•ˆ
- **pfctlè§„åˆ™ä¸ç¨³å®š**: é˜²ç«å¢™è§„åˆ™è¢«ç³»ç»Ÿé‡ç½®

### è§£å†³æ–¹æ¡ˆ
æä¾›äº†å®Œæ•´çš„æŒä¹…åŒ–é…ç½®å·¥å…·ï¼Œå¤§å¹…å‡å°‘é‡å¤æ‰§è¡Œéœ€æ±‚ã€‚

## è„šæœ¬è¯´æ˜

### ğŸš€ æ¨èä½¿ç”¨ï¼ˆæŒä¹…åŒ–æ–¹æ¡ˆï¼‰

#### `persistent_bridge_setup.sh` - æŒä¹…åŒ–ä¸»æœºç«¯é…ç½®
**æ ¸å¿ƒä¼˜åŠ¿**: è§£å†³é¢‘ç¹é‡æ–°æ‰§è¡Œé—®é¢˜
- ç½‘ç»œé…ç½®æŒä¹…åŒ–åˆ°ç³»ç»Ÿè®¾ç½®
- NATè§„åˆ™ä¿å­˜åˆ° `/etc/pf.anchors/`
- IPè½¬å‘å†™å…¥ `/etc/sysctl.conf`
- åŒ…å«è‡ªåŠ¨ä¿®å¤è„šæœ¬

```bash
chmod +x persistent_bridge_setup.sh
sudo ./persistent_bridge_setup.sh
```

#### `install_daemon.sh` - ç³»ç»Ÿç›‘æ§æœåŠ¡
**åŠŸèƒ½**: è‡ªåŠ¨ç›‘æ§å’Œä¿®å¤ç½‘ç»œçŠ¶æ€
- ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®
- ç½‘ç»œå˜åŒ–æ—¶è‡ªåŠ¨ä¿®å¤
- æ¯5åˆ†é’Ÿå®šæœŸå¥åº·æ£€æŸ¥
- ä¼‘çœ å”¤é†’åè‡ªåŠ¨ä¿®å¤

```bash
chmod +x install_daemon.sh
sudo ./install_daemon.sh
```

#### `bridge_monitor.sh` - å®æ—¶ç½‘ç»œç›‘æ§
**åŠŸèƒ½**: æä¾›å®æ—¶ç›‘æ§å’Œæ‰‹åŠ¨ä¿®å¤
- å®æ—¶ç›‘æ§ç½‘ç»œçŠ¶æ€
- å½©è‰²çŠ¶æ€æ˜¾ç¤º
- è‡ªåŠ¨é—®é¢˜æ£€æµ‹å’Œä¿®å¤
- è¯¦ç»†çš„å¥åº·æ£€æŸ¥æŠ¥å‘Š

```bash
chmod +x bridge_monitor.sh
sudo ./bridge_monitor.sh --monitor
```

### ğŸ“œ ä¼ ç»Ÿè„šæœ¬ï¼ˆä¸´æ—¶é…ç½®ï¼‰

#### `bridge_network_setup.sh` - ä¸»æœºç«¯ä¸´æ—¶é…ç½®
**ç‰¹ç‚¹**: ä¸´æ—¶é…ç½®ï¼Œé‡å¯åä¸¢å¤±
- å¿«é€Ÿæ¡¥æ¥ç½‘ç»œè®¾ç½®
- ä¸´æ—¶NATè§„åˆ™é…ç½®
- **é‡å¯åéœ€è¦é‡æ–°æ‰§è¡Œ**

```bash
chmod +x bridge_network_setup.sh
sudo ./bridge_network_setup.sh
```

#### `client_network_setup.sh` - å®¢æˆ·ç«¯é…ç½®
**åŠŸèƒ½**: é…ç½®è¿æ¥ç«¯Macçš„ç½‘ç»œ
- è‡ªåŠ¨æ£€æµ‹é›·é›³ç½‘æ¡¥æœåŠ¡
- é…ç½®IPåœ°å€å’ŒDNS
- ç½‘ç»œè¿é€šæ€§æµ‹è¯•

```bash
chmod +x client_network_setup.sh
sudo ./client_network_setup.sh
```

## å®Œæ•´éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šä¸»æœºç«¯æŒä¹…åŒ–é…ç½®
```bash
# 1. è¿è¡ŒæŒä¹…åŒ–é…ç½®ï¼ˆæ¨èï¼‰
sudo ./persistent_bridge_setup.sh

# 2. å®‰è£…ç³»ç»Ÿç›‘æ§æœåŠ¡ï¼ˆå¯é€‰ä½†æ¨èï¼‰
sudo ./install_daemon.sh
```

### ç¬¬äºŒæ­¥ï¼šå®¢æˆ·ç«¯é…ç½®
```bash
# åœ¨å¦ä¸€å°Macä¸Šè¿è¡Œ
sudo ./client_network_setup.sh
```

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å’Œç›‘æ§
```bash
# å®æ—¶ç›‘æ§ï¼ˆå¯é€‰ï¼‰
sudo ./bridge_monitor.sh --monitor

# ä¸€æ¬¡æ€§å¥åº·æ£€æŸ¥
sudo ./bridge_monitor.sh --check

# æ‰‹åŠ¨ä¿®å¤
sudo ./bridge_monitor.sh --repair
```

## ç½‘ç»œæ¶æ„

```
ä¸»æœºç«¯ (192.168.200.1)          å®¢æˆ·ç«¯ (192.168.200.2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WiFi (Internet)   â”‚         â”‚                     â”‚
â”‚         â†“           â”‚         â”‚                     â”‚
â”‚   bridge0 (NAT)     â”‚ â†â”€â”€â”€â”€â”€â†’ â”‚   é›·é›³ç½‘æ¡¥æ¥å£        â”‚
â”‚         â†“           â”‚  é›·é›³çº¿   â”‚                     â”‚
â”‚   é›·é›³æ¥å£(en1/en2)  â”‚         â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ç½‘æ®µ**: 192.168.200.0/24
- **ä¸»æœºç½‘å…³**: 192.168.200.1
- **å®¢æˆ·ç«¯IP**: 192.168.200.2
- **DNS**: 8.8.8.8, 1.1.1.1

## é«˜çº§åŠŸèƒ½

### ç³»ç»ŸæœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo launchctl list com.thunderbolt.bridge

# åœæ­¢æœåŠ¡
sudo launchctl stop com.thunderbolt.bridge

# å¯åŠ¨æœåŠ¡
sudo launchctl start com.thunderbolt.bridge

# å¸è½½æœåŠ¡
sudo launchctl unload /Library/LaunchDaemons/com.thunderbolt.bridge.plist
```

### ç›‘æ§è„šæœ¬é€‰é¡¹
```bash
# å®æ—¶ç›‘æ§ï¼ˆé»˜è®¤30ç§’é—´éš”ï¼‰
sudo ./bridge_monitor.sh --monitor

# è‡ªå®šä¹‰æ£€æŸ¥é—´éš”
sudo ./bridge_monitor.sh --interval 60 --monitor

# ä¸€æ¬¡æ€§å¥åº·æ£€æŸ¥
sudo ./bridge_monitor.sh --check

# æ‰‹åŠ¨ä¿®å¤
sudo ./bridge_monitor.sh --repair

# æ˜¾ç¤ºå½“å‰çŠ¶æ€
sudo ./bridge_monitor.sh --status
```

## æ—¥å¿—æ–‡ä»¶

- **æŒä¹…åŒ–é…ç½®æ—¥å¿—**: `/var/log/thunderbolt_bridge.log`
- **ç³»ç»ŸæœåŠ¡æ—¥å¿—**: `/var/log/thunderbolt_bridge_daemon.log`
- **ç›‘æ§è„šæœ¬æ—¥å¿—**: `/var/log/thunderbolt_bridge_monitor.log`

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®åé‡å¯å¤±æ•ˆ**
   - è§£å†³ï¼šä½¿ç”¨ `persistent_bridge_setup.sh` è€Œä¸æ˜¯ `bridge_network_setup.sh`

2. **ç½‘ç»œé—´æ­‡æ€§ä¸­æ–­**
   - è§£å†³ï¼šå®‰è£…ç³»ç»Ÿç›‘æ§æœåŠ¡ `install_daemon.sh`

3. **NATè½¬å‘ä¸å·¥ä½œ**
   - æ£€æŸ¥ï¼š`sudo pfctl -s nat`
   - ä¿®å¤ï¼š`sudo ./bridge_monitor.sh --repair`

4. **æ— æ³•è®¿é—®å¤–ç½‘**
   - æ£€æŸ¥WiFiè¿æ¥çŠ¶æ€
   - éªŒè¯IPè½¬å‘ï¼š`sysctl net.inet.ip.forwarding`

### æ‰‹åŠ¨æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥æ¡¥æ¥æ¥å£çŠ¶æ€
ifconfig bridge0

# æ£€æŸ¥NATè§„åˆ™
sudo pfctl -s nat

# æ£€æŸ¥IPè½¬å‘
sysctl net.inet.ip.forwarding

# æ£€æŸ¥é›·é›³è¿æ¥
system_profiler SPThunderboltDataType

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping 192.168.200.1
ping 8.8.8.8
```

## æ–‡ä»¶æƒé™

æ‰€æœ‰è„šæœ¬éƒ½éœ€è¦æ‰§è¡Œæƒé™ï¼š
```bash
chmod +x *.sh
```

æŒä¹…åŒ–é…ç½®éœ€è¦rootæƒé™ï¼š
```bash
sudo ./persistent_bridge_setup.sh
sudo ./install_daemon.sh
```

## ç‰ˆæœ¬å†å²

- **v1.0**: åŸºç¡€ä¸´æ—¶é…ç½®è„šæœ¬
- **v2.0**: æ–°å¢æŒä¹…åŒ–é…ç½®å’Œç³»ç»Ÿç›‘æ§
- **v2.1**: ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œæ·»åŠ å¼•å¯¼å’Œå»ºè®®

## æŠ€æœ¯è¦ç‚¹

- **æƒé™è¦æ±‚**: æ‰€æœ‰ç½‘ç»œé…ç½®æ“ä½œéœ€è¦sudoæƒé™
- **ç³»ç»Ÿä¾èµ–**: macOS networksetupã€ifconfigã€pfctlå·¥å…·
- **é…ç½®æŒä¹…åŒ–**: ä½¿ç”¨networksetupå’Œç³»ç»Ÿé…ç½®æ–‡ä»¶
- **ç›‘æ§æœºåˆ¶**: LaunchDaemon + å®šæœŸå¥åº·æ£€æŸ¥
- **è‡ªåŠ¨ä¿®å¤**: æ™ºèƒ½æ•…éšœæ£€æµ‹å’Œæ¢å¤æœºåˆ¶